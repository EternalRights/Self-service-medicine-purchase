import{g as v,a0 as W,E as h,P as R,p as A}from"./index-BhJGqM05.js";function D(t){const{url:i,onMessage:f,onError:d,onClose:S}=t,r=v(!1),s=v(!1),l=v(null),a=v(null),m=()=>{if(!(s.value||r.value)){s.value=!0,l.value=null;try{a.value=new WebSocket(i),a.value.onopen=()=>{r.value=!0,s.value=!1,console.log("WebSocket连接成功:",i)},a.value.onmessage=n=>{try{const c=JSON.parse(n.data);typeof f=="function"&&f(c)}catch(c){console.error("解析WebSocket消息失败:",c),typeof d=="function"&&d(c)}},a.value.onclose=n=>{r.value=!1,s.value=!1,console.log("WebSocket连接关闭:",n.code,n.reason),typeof S=="function"&&S(n),setTimeout(()=>{m()},5e3)},a.value.onerror=n=>{l.value=n,console.error("WebSocket错误:",n),h.error("WebSocket连接异常"),typeof d=="function"&&d(n)}}catch(n){s.value=!1,l.value=n,console.error("创建WebSocket失败:",n),setTimeout(()=>{m()},5e3)}}},g=n=>{if(a.value&&r.value)try{a.value.send(JSON.stringify(n))}catch(c){console.error("发送消息失败:",c),h.error("消息发送失败")}else console.warn("WebSocket未连接，无法发送消息"),h.warning("网络连接未建立")},p=()=>{a.value&&(a.value.close(),a.value=null)};return W(()=>{p()}),{isConnected:r,isConnecting:s,lastError:l,connect:m,send:g,close:p,ws:a.value}}var N=(t=>(t[t.MEDICAL_CONSULT=1]="MEDICAL_CONSULT",t[t.ORDER_CREATED=2]="ORDER_CREATED",t))(N||{});function T(t){return t?new Date(t).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):""}const L="/assets/high-priority-notification-Cn5hVrHE.mp3",O="/assets/normal-notification-BaomX-vz.mp3",_="/assets/medicine-box-BixbYBSc.png",M="/assets/shopping-cart-DPF2TXDA.png",B=R("notification",()=>{const t=v([]),i=v(0),{connect:f,close:d}=D({url:"ws://localhost:8080/ws/notifications",onMessage:S,onError:r,onClose:s});f();function S(e){try{const o=JSON.parse(e.data);a(o),o.message_type===N.MEDICAL_CONSULT?l("high"):l("normal")}catch(o){console.error("解析WebSocket消息失败:",o)}}function r(e){console.error("WebSocket连接错误:",e),setTimeout(()=>f(),5e3)}function s(e){console.log("WebSocket连接关闭:",e),setTimeout(()=>f(),5e3)}function l(e){const o=new Audio;o.src=e==="high"?L:O,o.play().catch(u=>{console.error("播放通知声音失败:",u)})}const a=e=>{const o={...e,id:Date.now(),timestamp:new Date,isRead:!1};t.value.unshift(o),i.value+=1,m(o),t.value.length>100&&t.value.pop()};function m(e){if(!("Notification"in window)){console.log("此浏览器不支持桌面通知");return}if(Notification.permission==="granted"){const o=e.title,u={body:e.content,icon:e.message_type===N.MEDICAL_CONSULT?_:M};new Notification(o,u)}else Notification.permission!=="denied"&&Notification.requestPermission().then(o=>{o==="granted"&&m(e)})}const g=e=>{const o=t.value.find(u=>u.id===e);o&&!o.isRead&&(o.isRead=!0,i.value-=1,w(e,!0))},p=()=>{t.value.forEach(e=>{e.isRead||(e.isRead=!0)}),i.value=0,C()},n=()=>{t.value=[],i.value=0},c=A(()=>i.value),y=e=>t.value.filter(o=>o.message_type===e),b=e=>T(e);async function w(e,o){try{await $api.orders.updateNotificationStatus(e,o)}catch(u){console.error("更新通知状态失败:",u);const k=t.value.find(E=>E.id===e);k&&(k.isRead=!o,i.value+=1)}}async function C(){try{await $api.orders.markAllNotificationsAsRead()}catch(e){console.error("标记所有通知为已读失败:",e)}}return{notifications:t,unreadCount:i,addNotification:a,markAsRead:g,markAllAsRead:p,clearNotifications:n,getUnreadCount:c,getNotificationsByType:y,formatNotificationTime:b,closeWebSocket:d}});export{N as M,M as c,T as f,_ as m,B as u};
