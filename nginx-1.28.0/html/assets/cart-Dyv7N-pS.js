import{P as x,z as S,u as k,g as l,p as d,T as C,E as y,U as f,V as T}from"./index-C-JNJE0h.js";import{u as E,M as w}from"./notification-BhJPW5DG.js";const D=x("cart",()=>{const u=S(),o=k(),p=E(),a=l([]),r=l(!1),g=d(()=>a.value.reduce((t,e)=>t+e.quantity,0)),m=d(()=>a.value.reduce((t,e)=>t+e.drug.price*e.quantity,0).toFixed(2)),v=t=>{if(!u.isOpen||t.stock_quantity<=0)return;const e=a.value.find(n=>n.drug.id===t.id);e?e.quantity<t.stock_quantity&&(e.quantity+=1):a.value.push({drug:{...t},quantity:1})},q=(t,e)=>{const n=a.value.find(i=>i.drug.id===t);n&&(e<=0?s(t):e>n.drug.stock_quantity?n.quantity=n.drug.stock_quantity:n.quantity=e)},_=t=>{const e=a.value.find(n=>n.drug.id===t);e&&e.quantity<e.drug.stock_quantity&&(e.quantity+=1)},h=async t=>{const e=a.value.find(n=>n.drug.id===t);if(e)if(e.quantity>1)e.quantity-=1;else try{await C.confirm("确定要删除该商品吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),s(t)}catch{}},s=t=>{const e=a.value.findIndex(n=>n.drug.id===t);e!==-1&&a.value.splice(e,1)[0]},c=()=>{a.value=[]};return{cartItems:a,totalItems:g,totalAmount:m,loading:r,addItem:v,updateQuantity:q,increaseQuantity:_,decreaseQuantity:h,removeItem:s,clearCart:c,checkout:async()=>{if(!u.isOpen){y.warning("当前暂停营业，无法结算");return}if(a.value.length===0){y.warning("购物车为空");return}try{r.value=!0;const t={user_id:o.userId,items:a.value.map(i=>({drug_id:i.drug.id,quantity:i.quantity,unit_price:i.drug.price}))},e=await f("/orders",t),n=a.value.map(i=>`${i.drug.generic_name} x ${i.quantity}`).join(", ");p.addNotification({title:"用户购物完成",content:`用户 ${o.userName} 完成一笔订单。订单号: ${e.id}, 总金额: ¥${e.total_amount}`,messageType:w.ORDER_CREATED}),c()}catch{}finally{r.value=!1}},loadCart:async()=>{try{r.value=!0;const t=await T("/cart");a.value=t.items}catch{}finally{r.value=!1}},syncCart:async()=>{try{r.value=!0,await f("/cart/sync",{items:a.value.map(t=>({drug_id:t.drug.id,quantity:t.quantity}))})}catch{}finally{r.value=!1}}}});export{D as u};
