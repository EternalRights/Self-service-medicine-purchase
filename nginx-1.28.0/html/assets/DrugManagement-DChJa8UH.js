import{$ as we,_ as he,g as m,f as Ce,B as De,c as C,d as a,w as t,r as u,E as _,a5 as Se,o as y,a as n,i as g,q as w,F as Fe,H as xe,N as P,O as $,a6 as ke,J as A,C as ae,G as r,S as Ue,a7 as Le}from"./index-BL_N-QZK.js";import{a as Ee,u as Oe,b as ze,c as He,d as Me}from"./drugs-C9JUtu9W.js";import{D as v,S as V}from"./drug-B6nnaEYq.js";const Re=j=>we.post("/upload",j),qe={class:"drug-management"},Ne={class:"toolbar"},Te=["src"],Be={class:"filter-section"},Ie={class:"drug-info"},Ye={class:"drug-details"},Pe={key:0,class:"rx-warning"},$e={class:"drug-name"},Ae={class:"drug-spec"},je={class:"drug-manufacturer"},Ke={class:"pagination-container"},Xe={key:0,class:"drug-detail"},Ge={class:"detail-header"},Je={class:"detail-info"},We={class:"detail-name"},Qe={class:"detail-spec"},Ze={class:"detail-manufacturer"},ea={class:"detail-status"},aa={class:"detail-section"},la={class:"detail-item"},ta={class:"detail-item"},oa={class:"detail-item"},sa={class:"detail-item"},na={class:"detail-item"},ua={__name:"DrugManagement",setup(j){const le=new URL("/assets/medicine-box-BixbYBSc.png",import.meta.url).href,O=[{value:v.OTC,label:"非处方药(OTC)"},{value:v.RX,label:"处方药(Rx)"},{value:v.MEDICAL,label:"医疗器械"},{value:v.HEALTH,label:"保健养生"}],te=[{value:V.ON_SHELF,label:"上架"},{value:V.OFF_SHELF,label:"下架"}],z=m([]),H=m(!1),c=Ce({page:1,pageSize:10,total:0}),M=m(""),R=m(null),q=m(null),h=m(!1),D=m(!1),s=m({generic_name:"",category:v.OTC,specification:"",manufacturer:"",image:null,composition:"",indications:"",usage_dosage:"",precautions:"",expiry_date:null}),oe={generic_name:[{required:!0,message:"请输入药品通用名",trigger:"blur"}],category:[{required:!0,message:"请选择药品分类",trigger:"change"}]},x=m(!1),i=m(null),N=m("basic"),T=m([]),S=async()=>{try{H.value=!0;const o={page:c.page,pageSize:c.pageSize,keyword:M.value,category:R.value,shelf_status:q.value};try{const e=await Ee(o);z.value=e.items||[],c.total=e.total||0}catch(e){_.error("获取药品列表失败: "+e.message),z.value=[],c.total=0}}catch(o){_.error("获取药品列表失败: "+o.message)}finally{H.value=!1}},F=()=>{c.page=1,S()},se=o=>{c.pageSize=o,S()},ne=o=>{c.page=o,S()},ue=()=>{D.value=!1,s.value={generic_name:"",category:v.OTC,specification:"",manufacturer:"",image:null,composition:"",indications:"",usage_dosage:"",precautions:"",expiry_date:null},h.value=!0},ie=o=>{D.value=!0,s.value={...o},h.value=!0},re=async()=>{try{if(D.value){const o=new FormData;Object.keys(s.value).forEach(e=>{e!=="imageFile"&&e!=="imagePreview"&&o.append(e,s.value[e])}),await He(s.value.id,o),_.success("药品信息更新成功")}else{const o=new FormData;Object.keys(s.value).forEach(e=>{e!=="imageFile"&&e!=="imagePreview"&&o.append(e,s.value[e])}),await Me(o),_.success("药品创建成功")}h.value=!1,S()}catch(o){_.error("操作失败: "+o.message)}},de=async o=>{try{o.updatingStatus=!0,await Oe(o.id,{shelf_status:o.shelf_status}),_.success("状态更新成功")}catch(e){_.error("状态更新失败: "+e.message),o.shelf_status=o.shelf_status===V.ON_SHELF?V.OFF_SHELF:V.ON_SHELF}finally{o.updatingStatus=!1}},ce=async o=>{i.value=o,N.value="basic";try{const e=await ze(o.id);T.value=[e]}catch(e){_.error("获取库存记录失败: "+e.message),T.value=[]}x.value=!0},pe=o=>{const e=o.type.startsWith("image/"),d=o.size/1024/1024<2;return e?d?!0:(_.error("图片大小不能超过 2MB"),!1):(_.error("只能上传图片文件"),!1)},me=async({file:o})=>{try{s.value.imageFile=o;const e=new FileReader;e.onload=f=>{s.value.imagePreview=f.target.result},e.readAsDataURL(o);const d=new FormData;d.append("file",o);const k=await Re(d);s.value.image=k.data,s.value.imageFile=null,_.success("图片上传成功")}catch(e){_.error("图片上传失败: "+e.message),s.value.imageFile=o}},K=o=>{switch(o){case v.OTC:return"success";case v.RX:return"warning";case v.MEDICAL:return"info";case v.HEALTH:return"";default:return"info"}},X=o=>{const e=O.find(d=>d.value===o);return e?e.label:"未知"};return De(()=>{S()}),(o,e)=>{var ee;const d=u("el-button"),k=u("el-icon"),f=u("el-input"),B=u("el-option"),I=u("el-select"),G=u("el-card"),p=u("el-table-column"),Y=u("el-image"),U=u("el-tag"),_e=u("el-switch"),J=u("el-table"),ge=u("el-pagination"),W=u("el-tab-pane"),ve=u("el-tabs"),Q=u("el-dialog"),b=u("el-form-item"),L=u("el-col"),Z=u("el-row"),fe=u("el-upload"),be=u("el-date-picker"),ye=u("el-form"),Ve=Se("loading");return y(),C("div",qe,[a(G,{class:"toolbar-card",shadow:"never"},{default:t(()=>[n("div",Ne,[a(d,{type:"primary",onClick:ue},{default:t(()=>[n("img",{src:w(le),alt:"新增药品",class:"button-icon"},null,8,Te),e[19]||(e[19]=g(" 新增药品 ",-1))]),_:1}),n("div",Be,[a(f,{modelValue:M.value,"onUpdate:modelValue":e[0]||(e[0]=l=>M.value=l),placeholder:"搜索药品名称",clearable:"",class:"search-input",onClear:F,onKeyup:Fe(F,["enter"])},{append:t(()=>[a(d,{onClick:F},{default:t(()=>[a(k,null,{default:t(()=>[a(w(xe))]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(I,{modelValue:R.value,"onUpdate:modelValue":e[1]||(e[1]=l=>R.value=l),placeholder:"全部分类",clearable:"",onChange:F},{default:t(()=>[(y(),C(P,null,$(O,l=>a(B,{key:l.value,label:l.label,value:l.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),a(I,{modelValue:q.value,"onUpdate:modelValue":e[2]||(e[2]=l=>q.value=l),placeholder:"全部状态",clearable:"",onChange:F},{default:t(()=>[(y(),C(P,null,$(te,l=>a(B,{key:l.value,label:l.label,value:l.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])])])]),_:1}),a(G,{class:"drug-list-card",shadow:"never"},{default:t(()=>[ke((y(),A(J,{data:z.value,style:{width:"100%"},"header-cell-style":{background:"#0F1420",color:"#fff"},"row-class-name":"drug-table-row"},{default:t(()=>[a(p,{prop:"id",label:"ID",width:"80"}),a(p,{label:"药品信息","min-width":"300"},{default:t(({row:l})=>[n("div",Ie,[a(Y,{src:l.image||require("@/assets/no-drugs.png"),fit:"cover",class:"drug-image"},null,8,["src"]),n("div",Ye,[l.category===w(v).RX?(y(),C("div",Pe," 凭医师处方购买和使用 ")):ae("",!0),n("div",$e,r(l.generic_name),1),n("div",Ae,r(l.specification),1),n("div",je,r(l.manufacturer),1)])])]),_:1}),a(p,{label:"分类",width:"120"},{default:t(({row:l})=>[a(U,{type:K(l.category)},{default:t(()=>[g(r(X(l.category)),1)]),_:2},1032,["type"])]),_:1}),a(p,{label:"库存",width:"100"},{default:t(({row:l})=>[n("span",{class:Ue({"low-stock":l.stock_quantity<10})},r(l.stock_quantity),3)]),_:1}),a(p,{label:"状态",width:"100"},{default:t(({row:l})=>[a(_e,{modelValue:l.shelf_status,"onUpdate:modelValue":E=>l.shelf_status=E,"active-value":w(V).ON_SHELF,"inactive-value":w(V).OFF_SHELF,loading:l.updatingStatus,onChange:E=>de(l)},null,8,["modelValue","onUpdate:modelValue","active-value","inactive-value","loading","onChange"])]),_:1}),a(p,{label:"有效期",width:"120"},{default:t(({row:l})=>[g(r(l.expiry_date||"--"),1)]),_:1}),a(p,{label:"操作",width:"180",fixed:"right"},{default:t(({row:l})=>[a(d,{type:"primary",size:"small",onClick:E=>ie(l)},{default:t(()=>[...e[20]||(e[20]=[g(" 编辑 ",-1)])]),_:1},8,["onClick"]),a(d,{type:"info",size:"small",onClick:E=>ce(l)},{default:t(()=>[...e[21]||(e[21]=[g(" 详情 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Ve,H.value]]),n("div",Ke,[a(ge,{"current-page":c.page,"onUpdate:currentPage":e[3]||(e[3]=l=>c.page=l),"page-size":c.pageSize,"onUpdate:pageSize":e[4]||(e[4]=l=>c.pageSize=l),total:c.total,"page-sizes":[10,20,30,50],layout:"total, sizes, prev, pager, next, jumper",background:"",onSizeChange:se,onCurrentChange:ne},null,8,["current-page","page-size","total"])])]),_:1}),a(Q,{modelValue:x.value,"onUpdate:modelValue":e[7]||(e[7]=l=>x.value=l),title:(ee=i.value)==null?void 0:ee.generic_name,width:"800px"},{footer:t(()=>[a(d,{onClick:e[6]||(e[6]=l=>x.value=!1)},{default:t(()=>[...e[27]||(e[27]=[g("关闭",-1)])]),_:1})]),default:t(()=>[i.value?(y(),C("div",Xe,[n("div",Ge,[a(Y,{src:i.value.image||require("@/assets/no-drugs.png"),fit:"cover",class:"detail-image"},null,8,["src"]),n("div",Je,[n("div",We,r(i.value.generic_name),1),n("div",Qe,r(i.value.specification),1),n("div",Ze,r(i.value.manufacturer),1),n("div",ea,[a(U,{type:K(i.value.category)},{default:t(()=>[g(r(X(i.value.category)),1)]),_:1},8,["type"]),a(U,{type:i.value.shelf_status===w(V).ON_SHELF?"success":"info"},{default:t(()=>[g(r(i.value.shelf_status===w(V).ON_SHELF?"上架中":"已下架"),1)]),_:1},8,["type"]),a(U,{type:i.value.stock_quantity<10?"danger":"success"},{default:t(()=>[g(" 库存: "+r(i.value.stock_quantity),1)]),_:1},8,["type"])])])]),a(ve,{modelValue:N.value,"onUpdate:modelValue":e[5]||(e[5]=l=>N.value=l),class:"detail-tabs"},{default:t(()=>[a(W,{label:"基本信息",name:"basic"},{default:t(()=>[n("div",aa,[n("div",la,[e[22]||(e[22]=n("span",{class:"detail-label"},"成分：",-1)),n("span",null,r(i.value.composition||"--"),1)]),n("div",ta,[e[23]||(e[23]=n("span",{class:"detail-label"},"适应症：",-1)),n("span",null,r(i.value.indications||"--"),1)]),n("div",oa,[e[24]||(e[24]=n("span",{class:"detail-label"},"用法用量：",-1)),n("span",null,r(i.value.usage_dosage||"--"),1)]),n("div",sa,[e[25]||(e[25]=n("span",{class:"detail-label"},"注意事项：",-1)),n("span",null,r(i.value.precautions||"--"),1)]),n("div",na,[e[26]||(e[26]=n("span",{class:"detail-label"},"有效期：",-1)),n("span",null,r(i.value.expiry_date||"--"),1)])])]),_:1}),a(W,{label:"库存记录",name:"inventory"},{default:t(()=>[a(J,{data:T.value,height:"300"},{default:t(()=>[a(p,{prop:"batch_number",label:"批号",width:"120"}),a(p,{prop:"quantity",label:"数量",width:"80"}),a(p,{prop:"create_time",label:"入库时间",width:"180"}),a(p,{prop:"expiry_date",label:"有效期",width:"120"}),a(p,{prop:"create_user_name",label:"操作人"})]),_:1},8,["data"])]),_:1})]),_:1},8,["modelValue"])])):ae("",!0)]),_:1},8,["modelValue","title"]),a(Q,{modelValue:h.value,"onUpdate:modelValue":e[18]||(e[18]=l=>h.value=l),title:D.value?"编辑药品信息":"新增药品",width:"800px"},{footer:t(()=>[a(d,{onClick:e[17]||(e[17]=l=>h.value=!1)},{default:t(()=>[...e[28]||(e[28]=[g("取消",-1)])]),_:1}),a(d,{type:"primary",onClick:re},{default:t(()=>[g(r(D.value?"更新":"创建"),1)]),_:1})]),default:t(()=>[a(ye,{ref:"drugFormRef",model:s.value,rules:oe,"label-width":"120px","label-position":"top"},{default:t(()=>[a(Z,{gutter:20},{default:t(()=>[a(L,{span:12},{default:t(()=>[a(b,{label:"药品通用名",prop:"generic_name"},{default:t(()=>[a(f,{modelValue:s.value.generic_name,"onUpdate:modelValue":e[8]||(e[8]=l=>s.value.generic_name=l)},null,8,["modelValue"])]),_:1})]),_:1}),a(L,{span:12},{default:t(()=>[a(b,{label:"分类",prop:"category"},{default:t(()=>[a(I,{modelValue:s.value.category,"onUpdate:modelValue":e[9]||(e[9]=l=>s.value.category=l),placeholder:"请选择分类"},{default:t(()=>[(y(),C(P,null,$(O,l=>a(B,{key:l.value,label:l.label,value:l.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),a(Z,{gutter:20},{default:t(()=>[a(L,{span:12},{default:t(()=>[a(b,{label:"规格",prop:"specification"},{default:t(()=>[a(f,{modelValue:s.value.specification,"onUpdate:modelValue":e[10]||(e[10]=l=>s.value.specification=l)},null,8,["modelValue"])]),_:1})]),_:1}),a(L,{span:12},{default:t(()=>[a(b,{label:"生产厂家",prop:"manufacturer"},{default:t(()=>[a(f,{modelValue:s.value.manufacturer,"onUpdate:modelValue":e[11]||(e[11]=l=>s.value.manufacturer=l)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),a(b,{label:"药品图片"},{default:t(()=>[a(fe,{class:"image-uploader",action:"#","show-file-list":!1,"before-upload":pe,"http-request":me},{default:t(()=>[s.value.imagePreview?(y(),A(Y,{key:0,src:s.value.imagePreview,class:"uploaded-image",fit:"cover"},null,8,["src"])):(y(),A(k,{key:1,class:"image-uploader-icon"},{default:t(()=>[a(w(Le))]),_:1}))]),_:1})]),_:1}),a(b,{label:"成分",prop:"composition"},{default:t(()=>[a(f,{modelValue:s.value.composition,"onUpdate:modelValue":e[12]||(e[12]=l=>s.value.composition=l),type:"textarea",rows:2},null,8,["modelValue"])]),_:1}),a(b,{label:"适应症（功能主治）",prop:"indications"},{default:t(()=>[a(f,{modelValue:s.value.indications,"onUpdate:modelValue":e[13]||(e[13]=l=>s.value.indications=l),type:"textarea",rows:2},null,8,["modelValue"])]),_:1}),a(b,{label:"用法用量",prop:"usage_dosage"},{default:t(()=>[a(f,{modelValue:s.value.usage_dosage,"onUpdate:modelValue":e[14]||(e[14]=l=>s.value.usage_dosage=l),type:"textarea",rows:2},null,8,["modelValue"])]),_:1}),a(b,{label:"注意事项",prop:"precautions"},{default:t(()=>[a(f,{modelValue:s.value.precautions,"onUpdate:modelValue":e[15]||(e[15]=l=>s.value.precautions=l),type:"textarea",rows:2},null,8,["modelValue"])]),_:1}),a(b,{label:"有效期",prop:"expiry_date"},{default:t(()=>[a(be,{modelValue:s.value.expiry_date,"onUpdate:modelValue":e[16]||(e[16]=l=>s.value.expiry_date=l),type:"date",placeholder:"选择有效期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},ca=he(ua,[["__scopeId","data-v-1a8e1d43"]]);export{ca as default};
